name: Nightly Build

on:
  workflow_dispatch:
  schedule:
    - cron: "0 0 * * *" # Run every day at midnight (UTC)

jobs:
  frontend-tests:
    name: Run Frontend Tests
    uses: ./.github/workflows/typescript_test.yml
    with:
      tests_folder: "tests/end-to-end"
    secrets:
      OPENAI_API_KEY: "${{ secrets.OPENAI_API_KEY }}"
      STORE_API_KEY: "${{ secrets.STORE_API_KEY }}"

  backend-unit-tests:
    name: Run Backend Unit Tests
    uses: ./.github/workflows/python_test.yml
    with:
      python-versions: '["3.10", "3.11", "3.12"]'

  backend-integration-tests:
    name: Run Backend Integration Tests
    uses: ./.github/workflows/integration_tests.yml
    with:
      python-versions: '["3.10", "3.11", "3.12"]'

  run-nightly-build:
    name: Run Nightly Langflow Build
    needs: [backend-unit-tests, backend-integration-tests]
    uses: ./.github/workflows/release.yml
    with:
      release_package_base: false
      release_package_main: true
      build_docker_base: false
      build_docker_main: true
      create_release: false

  slack-notification:
    name: Send Slack Notification
    needs: run-nightly-build
    runs-on: ubuntu-latest
    steps:
      - name: Send success notification to Slack
        if: success()
        uses: slackapi/slack-github-action@v1.26.0
        with:
          payload: |
            {
              "channel": "#langflow-nightly-builds",
              "username": "GitHub Actions",
              "text": "Nightly Build Successful :white_check_mark:",
              "icon_emoji": ":rocket:"
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: Send failure notification to Slack
        if: failure()
        uses: slackapi/slack-github-action@v1.26.0
        with:
          payload: |
            {
              "channel": "#langflow-nightly-builds",
              "username": "GitHub Actions",
              "text": "Nightly Build Failed :x:",
              "icon_emoji": ":warning:"
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
